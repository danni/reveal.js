<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>more than a side salad:
    behaviour driven testing and test driven design in Django with Lettuce</title>

		<meta name="author" content="Danielle Madeley">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="css/reveal.min.css">
		<link rel="stylesheet" href="css/theme/danni.css" id="theme">

		<!-- For syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- If the query includes 'print-pdf', use the PDF print sheet -->
		<script>
			document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h1>more than a side salad:</h1>
          <h3>behaviour driven testing and test driven design in Django with
            Lettuce</h3>

          <p>Danielle Madeley</p>
          <p><small>
            <i class="icon-globe"></i> blogs.gnome.org/danni
            <i class="icon-twitter"></i> dannipenguin
          </small></p>
				</section>

        <section>
          <h1>Just what is test driven development?</h1>
        </section>

        <section>
          <img src="http://www.troll.me/images/winter-is-coming/brace-yourselves-testing-is-coming.jpg"/>
        </section>

        <section>
          <h1>Tests first; code second</h1>

          <aside class="notes">
            <p>
              Software development methodolgy where we write the tests first.
            </p>
            <p>
              Once we have tests, we can write code that makes the tests
              pass.
            </p>
          </aside>
        </section>

        <section data-background="white">
          <img src="http://wellington.pm.org/archive/200606/tdd/images/tdd_cycle.jpg"/>

          <aside class="credit bg-dark">
            http://www.nilkanth.com/2007/06/08/three-monkeys-of-test-driven-development/
          </aside>
          <aside class="notes">
            <p>
              Tests first, code second.
            </p>
            <p>
              Important both for bug fixing (write a test that demonstrates
              regression and then fix it) AND feature development.
            </p>
          </aside>
        </section>

        <section>
          <h2>But how do we write tests when we don't know what the code
            looks like?</h2>

          <aside class="notes">
            <p>It's very hard to write unit tests when you don't know what
            it is that you're testing yet</p>
          </aside>
        </section>

        <section>
          <h1>Don't test code; test behaviours</h1>
        </section>

        <section data-background="http://i.imgur.com/QpZe0LD.jpg">
        </section>

        <section>
          <div class="story">
          <p><em>As a</em> visitor to the site</p>
          <p><em>I want</em> to create an account using my Google login</p>
          <p><em>So that</em> I can log in without needing another password</p>
          </div>
        </section>

        <section
          data-background="http://farm4.staticflickr.com/3184/2660160225_bf77317442_b_d.jpg"
          class="bg-dark">

          <h2>Given</h2>
          <p class="story fragment fade-in expand" data-fragment-index="2">
            I have a valid Google account
          </p>
          <h2>When</h2>
          <p class="story fragment fade-in expand" data-fragment-index="3">
            I visit the site
          </p>
          <p class="story fragment fade-in expand" data-fragment-index="4">
            And I click create account
          </p>
          <h2>Then</h2>
          <p class="story fragment fade-in expand" data-fragment-index="5">
            I am redirected to Google
          </p>

          <aside class="credit">
            http://www.flickr.com/photos/27369469@N08/2660160225
          </aside>

          <aside class="notes">
            <p>3 verbs: given, when and then</p>
            <p>Given sets up the state for testing something</p>
            <p>When says what we do</p>
            <p>Then tests what the output is</p>
            <p>This is neat because (a) it describes the test</p>
            <p>And (b) it is readable by non-programmers</p>
            <p>This forms the basis of Gherkin syntax as used by cucumber</p>
          </aside>
        </section>

        <section
          data-background="http://farm4.staticflickr.com/3285/2742564457_ce2995fcc1_b_d.jpg"
          class="bg-dark">
          <h1>Lettuce</h1>
          <h3>http://lettuce.it</h3>
          <aside class="credit">
            http://www.flickr.com/photos/65567316@N00/2742564457
          </aside>

          <aside class="notes">
            <p>Lettuce is a cucumber implementation in Python</p>
            <p>Similar tools are behave and Freshen</p>
          </aside>
        </section>

        <section data-background="#3F3F3F">
          <pre><code data-trim class="gherkin_en">
Feature: Authenticate to API

  As a searcher/API user
  I want to authenticate to the API
  So that I can make queries

  Scenario: I am not authenticated to the API
    When I get the resource "/api/v3/hello/"

    Then I get the response code 401
          </code></pre>

          <aside class="notes">
            <p>These are called feature files. A feature is made up of
            scenarios</p>
          </aside>
        </section>

        <section data-background="#486082">
          <img src="http://i.imgur.com/Z3tULgQ.jpg"/>
        </section>

        <section
          data-background="http://farm1.staticflickr.com/218/504844510_11ef5c2ee7_b_d.jpg"
          class="bg-dark">
          <h1>Steps</h1>
          <aside class="credit">
            http://www.flickr.com/photos/60364452@N00/504844510
          </aside>

          <aside class="notes">
            <p>Steps are the generic code that executes the test</p>
          </aside>
        </section>

        <section data-background="#3F3F3F">
          <pre><code data-trim>
from lettuce import step, world

@step(r'I get the resource "([^"]*)"')
def get_resource(step, url):
    """
    Make a GET request to the given URL
    """

    world.response = world.client.get(url)
          </code></pre>
        </section>

        <section
          data-background="http://farm4.staticflickr.com/3456/3201514924_fce1d1b640_b_d.jpg"
          class="bg-dark">
          <h1>Steps are stateful</h1>

          <aside class="credit">
            http://www.flickr.com/photos/chrisconnell/3201514924/
          </aside>
        </section>

        <section data-background="#3F3F3F">
          <pre><code data-trim>
from django.test.client import Client
from lettuce import before, step, world
from nose.tools import assert_equals

@before.each_scenario
def set_default_client(scenario):

    world.client = Client()

@step(r'I get the resource "([^"]*)"')
def get_resource(step, url):

    world.response = world.client.get(url)

@step(r'I get the response code (\d+)')
def check_response_code(step, code):

    code = int(code)
    assert_equals(world.response.status_code, code)
          </code></pre>
        </section>

        <section>
          <h2>./manage.py harvest</h2>

          <aside class="notes">
            <p>Entry point for running lettuce test from Django</p>
            <p>Will create a test server and *optionally* create a test
            database</p>
            <p>Also uses TEST_RUNNER</p>
          </aside>
        </section>

        <section data-background="#3F3F3F">
          <pre><code data-trim>
# settings.py

INSTALLED_APPS = (
    ...
    'lettuce.django',
    'myapp',
)

LETTUCE_APPS = (
    'myapp',
)

LETTUCE_USE_TEST_DATABASE = True
          </code></pre>
      </section>

      <section
        data-background="http://farm3.staticflickr.com/2424/3599012763_eddf0fd56c_b_d.jpg"
        class="bg-dark">
        <h1>Selenium</h1>
        <aside class="credit">
          http://www.flickr.com/photos/21663307@N02/3599012763
        </aside>

        <aside class="notes">
          <p>Lettuce webdriver</p>
        </aside>
      </section>

      <section data-background="#3F3F3F">
        <pre><code data-trim>
from lettuce import before, world
# import external lettuce steps
import lettuce_webdriver.webdriver

@before.all
def set_browser():
    """
    Create a browser instance for use in tests.
    """

    world.browser = webdriver.PhantomJS(...)
    world.browser.set_window_size(1200, 800)
        </code></pre>

        <aside class="notes">
          <p>We create the browser webdriver much like we created the
          client</p>
          <p>lettuce.webdriver looks for something called world.browser</p>
        </aside>
      </section>

      <section data-background="#3F3F3F">
        <pre><code data-trim>
def site_url(url):

    base_url = 'http://%s' % socket.gethostname()

    if server.port is not 80:
        base_url += ':%d' % server.port

    return urlparse.urljoin(base_url, url)


@step("I visit the site")
def open_site(step):

    step.given('I visit "%s"' % site_url('/'))
        </code></pre>

        <aside class="notes">
          <p>Django's test client knows how to connect to the test server</p>
          <p>here we need something a little extra</p>
          <p>Lettuce actually provides a site_url() method, but here I'm
          replacing it to allow the webdriver to run on a different host</p>
        </aside>
      </section>

      <section data-background="#3F3F3F">
        <pre><code data-trim class="gherkin_en">
  Scenario: Add consumer with blank Contact name
    When I log in to admin with username "admin" and password "secret"
    And I click "Consumers"
    And I click "Add consumer"
    And I fill in "Organisation" with "OOOO"
    And I fill in "Contact name" with ""
    And I fill in "Contact number" with "0399999999"
    And I fill in "Website" with "www.test.com"
    And I press "Save"

    Then I should see "This field is required"
    And there should be 0 consumers in the database
        </code></pre>

        <aside class="notes">
          <p>
          Here's an example of filling out a form. Everything but the first
          step is built into lettuce or L-W-D
          </p>
          <p>
          The last step actually makes this a good time to talk about...
          </p>
        </aside>
      </section>

      <section>
        <h1>Fixtures</h1>
      </section>

      <section data-background="#3F3F3F">
       <pre><code data-trim class="gherkin_en">
Feature: Create new API key

  As an administrator
  I want to create a new API key
  So that I can enable others to query API

  Background:
    Given I have users in the database:
      | username | password | is_superuser |
      | admin    | secret   | true         |
        </code></pre>
      </section>

      <section data-background="#3F3F3F">
        <h2>Built in steps using Django's model introspection</h2>
        <pre class="fragment fade-in" data-fragment-index="2"><code data-trim>
Given I have users in the database:
  ...
        </code></pre>
        <pre class="fragment fade-in" data-fragment-index="3"><code data-trim>
Then there should be 1 consumer in the database
        </code></pre>
        <pre class="fragment fade-in" data-fragment-index="4"><code data-trim>
And consumer should be present in the database:
  ...
        </code></pre>

        <aside class="notes">
          <p>
            Contributed these steps to lettuce.django, simplifies model
            creation and inspection
          </p>
        </aside>
      </section>

      <section data-background="#3F3F3F">
        <h3>Which are extendable</h3>
        <pre><code data-trim>
@creates_models(User)
def create_user(step):
    data = hashes_data(step)
    for hash_ in data:
        is_superuser = hash_.pop('is_superuser', False)

        if is_superuser:
            user = User.objects.create_superuser(**hash_)
        else:
            user = User.objects.create_user(**hash_)

        user.save()

    reset_sequence(User)
        </code></pre>
      </section>

      <section>
        <h1>Best practice</h1>
      </section>

      <section>
        <img src="http://i.imgur.com/cEOO46R.jpg"/>

        <aside class="notes">
          <p>Don't be too high level, complex steps will require their own
          tests</p>
          <p>e.g. this is bad</p>
        </aside>
      </section>

      <section data-background="#3F3F3F">
        <pre><code data-trim class="gherkin_en">
Given I have items in my cart

When I go to checkout
And I pay for the items

Then everything worked
        </code></pre>

        <aside class="notes">
          <p>Similarly -- too low level -- you'll tie your test closely to
          your implementation</p>
          <p>These are integration tests, but remember your test hygiene</p>
        </aside>
      </section>

      <section>
        <h2>write reusable steps</h2>

        <aside class="notes">
          <p>Parameterise where possible</p>
          <p>You can have steps call other steps, but this can lead to an
          unmaintainable mess. Consider factoring out the common code.</p>
        </aside>
      </section>

      <section data-background="#3F3F3F">
        <h3>write reusable scenarios</h3>
        <pre><code data-trim style="font-size: 20pt;" class="gherkin_en">
Scenario Outline: I edit a user to add a team
    Given users have permissions:
        | user         | organisation | permission        |
        | peon@org.org | OrgCorp      | organisation_user |
    And I log in with email "&lt;email&gt;" through the profile server

    When I visit site page "organisation/1/admin/user/4/edit"
    And I select option "Team 1" from selector "Team"
    And I press "Save"

    Then there should be 1 organisation member metadata in the database
    Then organisation member metadata should be present in the database:
        | organisation__name | user__email  | team   |
        | OrgCorp            | peon@org.org | Team 1 |

    Examples:
        | email             |
        | god@god.org       |
        | superuser@org.org |
        | poweruser@org.org |
        </code></pre>
      </section>

      <section>
        <h2>tie each feature file to a single story</h2>

        <aside class="notes">
          <p>Write the story in the top of the feature</p>
          <p>Also the ticket number?</p>
          <p>You should be able to get the feature name from the ticket
          name</p>
        </aside>
      </section>

      <section>
        <h2>include scenarios and anti-scenarios</h2>

        <aside class="notes">
          <p>Make a product owner reviewing the tests part of UAT</p>
        </aside>
      </section>

      <section
        data-background="http://farm4.staticflickr.com/3161/3050378171_f944bc8c4a_b_d.jpg">
        <h1>Other uses</h1>
        <aside class="credit">
          http://www.flickr.com/photos/omcoc/3050378171/
        </aside>

        <aside class="notes">
          Use it as part of your docs toolchain, e.g. include it inside
          a Restructured text block to generate steps and screenshots
        </aside>
      </section>

      <section
        data-background="http://farm4.staticflickr.com/3494/3763640652_c01592c5d8_b_d.jpg">
        <h1>fin ;-P</h1>
        <h3>questions?</h3>

        <div class="white breakout"><p><small>
          <em>colophon</em>
          This presentation was done in reveal.js using
          Junction, Cantarell and Source Code Pro with photography from
          the Creative Commons.
        </small></p>
        <p><small><img
          src="http://blogs.gnome.org/danni/files/2013/05/Infoxchange_logo.jpg"/>
          Infoxchange is hiring. Come and chat to me!
        </small></p></div>
        <p>
          <i class="icon-globe"></i> blogs.gnome.org/danni
          <i class="icon-twitter"></i> dannipenguin
        </p>

        <aside class="credit">
          http://www.flickr.com/photos/mau3ry/3763640652/
        </aside>
      </section>

			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.min.js"></script>

		<script>

			// Full list of configuration options available here:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: false,
				progress: false,
				history: true,
				center: true,

				theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
				transition: Reveal.getQueryHash().transition || 'zoom', // default/cube/page/concave/zoom/linear/fade/none

				// Optional libraries used to extend on reveal.js
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
					{ src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
				]
			});

		</script>

	</body>
</html>
